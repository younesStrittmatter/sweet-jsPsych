
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Symbol plaid (simple)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <link rel="stylesheet" href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css"/>
  <style>html, body { margin:0; height:100%; background:#111 }</style>
</head>
<body>
  <!-- Built IIFE of the plugin -->
  <script src="../dist/index.browser.min.js"></script>

  <script>
    const jsPsych = initJsPsych({});

    const ORI_R = 45;   // "/"
    const ORI_L = 135;  // "\" (left-leaning)
    const flip = d => (d === ORI_R ? ORI_L : ORI_R);
    const label = d => ((((d % 180) + 180) % 180) === ORI_R ? "right" : "left");

    // Use px directly (keep prior feel by assuming 60 px/deg)
    const PPD = 60;
    const R_INNER = Math.round(1.8 * PPD); // ≈108 px
    const R_OUTER = Math.round(3.0 * PPD); // ≈180 px

    const BG = "#111";
    const GRAY30 = "#4d4d4d"; // ~30%
    const GRAY55 = "#8c8c8c"; // ~55%

    // Minimal helpers producing trials of the new plugin
    const fixation = (ms = 200) => ({
      type: window.jsPsychSymbol,
      background: "transparent",
      items: [{ shape: "cross", color: GRAY30, armLen: 40, armWidth: 6 }],
      trialDuration: ms
    });

    const placeholder = (prime_ms) => ({
      type: window.jsPsychSymbol,
      background: "transparent",
      items: [{ shape: "ring", color: GRAY55, innerRadius: R_INNER, outerRadius: R_OUTER }],
      trialDuration: Math.max(0, 400 - prime_ms)
    });

    // Prime: a circle filled with oriented stripes; radius = R_INNER
    const prime = (ori_deg, ms) => ({
      type: window.jsPsychSymbol,
      background: "transparent",
      items: [{
        shape: "circle",
        radius: R_INNER,
        color: "#777",
        texture: { type: "stripes", bar: 12, duty: 0.5, angle: ori_deg }
      }],
      trialDuration: ms
    });

    // Target plaid: multiply two stripe-filled circles + overlay ring
    const plaid = (darker_deg) => {
      const STRONG_COLORS = ["#bbbbbb", "#333333"]; // higher contrast
      const WEAK_COLORS   = ["#999999", "#666666"]; // lower contrast
      return {
        type: window.jsPsychSymbol,
        background: "transparent",
        items: [
          {
            shape: "circle", radius: R_INNER, color: "#777", blend: "multiply",
            texture: { type: "stripes", bar: 12, duty: 0.5, angle: ORI_R,
                       colors: (darker_deg === ORI_R ? STRONG_COLORS : WEAK_COLORS) }
          },
          {
            shape: "circle", radius: R_INNER, color: "#777", blend: "multiply",
            texture: { type: "stripes", bar: 12, duty: 0.5, angle: ORI_L,
                       colors: (darker_deg === ORI_L ? STRONG_COLORS : WEAK_COLORS) }
          },
          { shape: "ring", color: GRAY55, innerRadius: R_INNER, outerRadius: R_OUTER, z: 10 }
        ],
        trialDuration: 84
      };
    };

    // Mask: circle filled with noise
    const mask = (ms) => ({
      type: window.jsPsychSymbol,
      background: "transparent",
      items: [{ shape: "circle", radius: R_INNER, color: "#777",
                texture: { type: "noise", cell: 6, seed: 1337, mix: 0.6, colors:["#333","#ccc"] } }],
      trialDuration: ms
    });

    // Left/Right response
    const respLeftRight = (darker_deg) => {
      const correct = (label(darker_deg) === "left") ? "f" : "j";
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div style="color:#ddd;text-align:center;font-size:20px">Which orientation was darker?<br/><br/>
          <b>F</b> = Left-leaning ( \\ ) &nbsp;&nbsp; <b>J</b> = Right-leaning ( / )</div>`,
        choices: ["f","j"],
        on_finish: d => { d.correct_key = correct; d.correct = (d.response === correct); }
      };
    };

    // Probe: a thin rectangle rotated to the orientation
    const probeStripe = (ori_deg) => ({
      type: window.jsPsychSymbol,
      background: "transparent",
      items: [{ shape: "rectangle", width: Math.round(7.0 * PPD), height: Math.max(2, Math.round(0.6 * PPD)),
                rotation: ori_deg, color: "#b3b3b3" }],
      trialDuration: 200
    });

    const respSameDiff = (isSame) => {
      const correct = isSame ? "f" : "j";
      return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `<div style="color:#ddd;text-align:center;font-size:20px">Is the outer gray stripe in the <b>same</b> direction as the darker set of lines?<br/><br/>
          <b>F</b> = Same &nbsp;&nbsp; <b>J</b> = Different</div>`,
        choices: ["f","j"],
        on_finish: d => { d.correct_key = correct; d.correct = (d.response === correct); }
      };
    };

    // ---- Demo block (minimal params) ----
    const PRIME_MS = 68;
    const DARKER = ORI_R;
    const PRIME_CONGRUENT = true;
    const primeOri = PRIME_CONGRUENT ? DARKER : flip(DARKER);
    const probeSame = true;

    const block = [
      fixation(200),
      placeholder(PRIME_MS),
      prime(primeOri, PRIME_MS),
      plaid(DARKER),
      mask(200),
      respLeftRight(DARKER),

      fixation(200),
      placeholder(PRIME_MS),
      prime(primeOri, PRIME_MS),
      plaid(DARKER),
      mask(500),
      probeStripe(probeSame ? DARKER : flip(DARKER)),
      respSameDiff(probeSame)
    ];

    const start = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `<div style="color:#ddd;text-align:center">
        <b>Symbol plaid (simple)</b><br/><br/>
        This demo uses the new sb-symbol API where shapes can be filled with textures.<br/>
        No windows/masks/deg needed—just pixels and layers. Press any key to start.
      </div>`
    };

    const redTriangle = {
      type: window.jsPsychSymbol,
      background: "transparent",
      items: [ { shape: "triangle", side: Math.round(2.0 * PPD), color: "red" } ],
      trialDuration: 1500,
      choices: ["f","j"]
    };

    jsPsych.run([start, ...block, redTriangle]);
  </script>
</body>
</html>
